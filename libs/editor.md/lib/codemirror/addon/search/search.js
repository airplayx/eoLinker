!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e):e(CodeMirror)}(function(e){"use strict";function o(e,o){return"string"==typeof e?e=new RegExp(e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),o?"gi":"g"):e.global||(e=new RegExp(e.source,e.ignoreCase?"gi":"g")),{token:function(o){e.lastIndex=o.pos;var t=e.exec(o.string);return t&&t.index==o.pos?(o.pos+=t[0].length,"searching"):void(t?o.pos=t.index:o.skipToEnd())}}}function t(){this.posFrom=this.posTo=this.query=null,this.overlay=null}function r(e){return e.state.search||(e.state.search=new t)}function n(e){return"string"==typeof e&&e==e.toLowerCase()}function i(e,o,t){return e.getSearchCursor(o,t,n(o))}function a(e,o,t,r,n){e.openDialog?e.openDialog(o,n,{value:r}):n(prompt(t,r))}function c(e,o,t,r){e.openConfirm?e.openConfirm(o,r):confirm(t)&&r[0]()}function s(e){var o=e.match(/^\/(.*)\/([a-z]*)$/);if(o)try{e=new RegExp(o[1],o[2].indexOf("i")==-1?"":"i")}catch(t){}return("string"==typeof e?""==e:e.test(""))&&(e=/x^/),e}function l(e,t){var i=r(e);return i.query?f(e,t):void a(e,d,"Search for:",e.getSelection(),function(r){e.operation(function(){r&&!i.query&&(i.query=s(r),e.removeOverlay(i.overlay,n(i.query)),i.overlay=o(i.query,n(i.query)),e.addOverlay(i.overlay),e.showMatchesOnScrollbar&&(i.annotate&&(i.annotate.clear(),i.annotate=null),i.annotate=e.showMatchesOnScrollbar(i.query,n(i.query))),i.posFrom=i.posTo=e.getCursor(),f(e,t))})})}function f(o,t){o.operation(function(){var n=r(o),a=i(o,n.query,t?n.posFrom:n.posTo);(a.find(t)||(a=i(o,n.query,t?e.Pos(o.lastLine()):e.Pos(o.firstLine(),0)),a.find(t)))&&(o.setSelection(a.from(),a.to()),o.scrollIntoView({from:a.from(),to:a.to()}),n.posFrom=a.from(),n.posTo=a.to())})}function u(e){e.operation(function(){var o=r(e);o.query&&(o.query=null,e.removeOverlay(o.overlay),o.annotate&&(o.annotate.clear(),o.annotate=null))})}function p(e,o){e.getOption("readOnly")||a(e,m,"Replace:",e.getSelection(),function(t){t&&(t=s(t),a(e,y,"Replace with:","",function(r){if(o)e.operation(function(){for(var o=i(e,t);o.findNext();)if("string"!=typeof t){var n=e.getRange(o.from(),o.to()).match(t);o.replace(r.replace(/\$(\d)/g,function(e,o){return n[o]}))}else o.replace(r)});else{u(e);var n=i(e,t,e.getCursor()),a=function(){var o,r=n.from();!(o=n.findNext())&&(n=i(e,t),!(o=n.findNext())||r&&n.from().line==r.line&&n.from().ch==r.ch)||(e.setSelection(n.from(),n.to()),e.scrollIntoView({from:n.from(),to:n.to()}),c(e,h,"Replace?",[function(){s(o)},a]))},s=function(e){n.replace("string"==typeof t?r:r.replace(/\$(\d)/g,function(o,t){return e[t]})),a()};a()}}))})}var d='Search: <input autocomplete="off" type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',m='Replace: <input autocomplete="off" type="text" style="width: 10em" class="CodeMirror-search-field"/> <span style="color: #888" class="CodeMirror-search-hint">(Use /re/ syntax for regexp search)</span>',y='With: <input autocomplete="off" type="text" style="width: 10em" class="CodeMirror-search-field"/>',h="Replace? <button>Yes</button> <button>No</button> <button>Stop</button>";e.commands.find=function(e){u(e),l(e)},e.commands.findNext=l,e.commands.findPrev=function(e){l(e,!0)},e.commands.clearSearch=u,e.commands.replace=p,e.commands.replaceAll=function(e){p(e,!0)}});